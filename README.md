# GulpAssets

Rails Plugin to augment frontend development with a gulp/webpack based
workflow.

## Usage

1. Add `gem 'gulp_assets', git: 'git@github.com:HitFox/gulp_assets.git'` gem to your Gemfile and run `bundle install`.
2. Run `rails generate gulp_assets` to generate all necessary files.
3. Develop your frontend code in the `frontend` directory
4. Reference files generated by gulp using the `gulp_asset_path` helper
5. Run `npm start` during development for livereload/Webpack
   Hot Module replacement.

## Structure

`frontend/assets` contains static assets (images, fonts, icons). A
static asset is a file that is not processed and that does not contain
references to other files. They are simply copied to
`public/assets/assets`.

`frontend/stylesheets` contains SCSS files which are compiled to
`public/assets/stylesheets`. Files beginning with underscores are
ignored.

`frontend/javascripts/main.js` is the entry point for the client-side
Javascript. This is picked up by Webpack, bundled and copied to
`public/assets/javascripts`. If you need additional entry points,
please adjust the webpack configuration accordingly.

## Gulp Commands

### `gulp default`

Runs the webpack development server which will watch files, trigger
livereload and serve static assets.

This also runs if you execute `npm start`.

### `gulp precompile`

Compiles assets for production, hashes their names and generates a
`rev-mainfest.json`, which is used by the `gulp_asset_path` helper to
generate the correct links with the hash in the filename.

## Referencing gulp asets from Rails views

The `gulp_assets_path` helper takes a partial path as a parameter that
sits inside the `public/assets` folder. It then operates differently,
depending on the `RAILS_ENV`:

- development: Prepend the path with the correct location on the webpack
  dev server, usually `//localhost:8080/assets`. `javascripts/main.js`
  would become `//localhost:8080/assets/javascripts/main.js`.
- production: Prepend the path with the correct asset path and replace
  the filename with the hashed version. `javascripts/main.js` would
  become `/assets/javascripts/main-a42bb48a5f83.js`.

## Examples

CSS:
 
 - `frontend/stylesheets/main.scss` Input file
 - `public/assets/stylesheets/main.css` Output File
 - `<link rel="stylesheet" media="all" href="<%=gulp_asset_path('stylesheets/main.css')%>"/>` Used to link to the file.

JS: 
 - `frontend/javscripts/main.js` Input file
 - `public/assets/javscripts/main.js` Output File
 -  `<script src="<%=gulp_asset_path('javascripts/main.js')%>"></script>`

## TODO

- ~~Parse Rev~~
- ~~Inject Gulp helper~~
- ~~Configure webpack host~~
- ~~Offer command to install gulp infrastructure into rails app~~
- Hook into Assets:precompile
- Inject livereload/browsersync (https://github.com/Browsersync/recipes/tree/master/recipes/gulp.sass)
- Generate procfile for Foreman
- Overwrite asset_path to make this work with `javascript_include_tag`
  and `styleheet_link_tag`.
- Include CORS in Rails for development if necessary.

### Gulpfile Todo:
- Make Hot loader dependency opional
- Production Build Task
- Config.js with host and port for webpack dev server (Also consumed by
  Rails plugin)
- Install Uglify plugin for webpack.
- Webpack referencing hashed files (manifest helper or gulp-fingerprint?)
- Uglify for SCSS
- Autoprefixer
- Image minifier
